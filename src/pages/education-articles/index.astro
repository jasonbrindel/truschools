---
import Layout from '@/layouts/Layout.astro';

const title = "Education Articles";
const description = "Expert guides and insights on K-12 education, college admissions, financial aid, and finding the right school for your child.";

// Load all article files as raw text at build time
const articleModules = import.meta.glob('./*.astro', { query: '?raw', import: 'default', eager: true });

// Load all images
const allImages = import.meta.glob<{ default: ImageMetadata }>('/src/images/*.jpg', { eager: true });

// Get article ratings from database
const db = (Astro.locals as any).runtime?.env?.DB;
let ratingsMap: Record<string, number> = {};

if (db) {
  try {
    const ratingsResult = await db.prepare('SELECT slug, helpful_count FROM article_ratings').all();
    if (ratingsResult.results) {
      ratingsResult.results.forEach((r: any) => {
        ratingsMap[r.slug] = r.helpful_count || 0;
      });
    }
  } catch (e) {
    // Table might not exist yet, that's ok
    console.error('Error fetching ratings:', e);
  }
}

interface Article {
  slug: string;
  title: string;
  description: string;
  tags: string[];
  image: ImageMetadata | null;
  publishDate: string | null;
  helpfulCount: number;
}

// Parse article metadata from raw file content
const articles: Article[] = Object.entries(articleModules)
  .filter(([path]) => !path.includes('index.astro'))
  .map(([path, content]) => {
    const slug = path.replace('./', '').replace('.astro', '');
    const rawContent = content as string;

    // Extract metadata from file content using regex
    const titleMatch = rawContent.match(/const title\s*=\s*["']([^"']+)["']/);
    const descriptionMatch = rawContent.match(/const description\s*=\s*["']([^"']+)["']/);
    const imageMatch = rawContent.match(/import heroImage from ['"]@\/images\/([^'"]+)['"]/);
    const publishDateMatch = rawContent.match(/const publishDate\s*=\s*["']([^"']+)["']/);

    // Try to extract tags array first, fall back to single category for backwards compatibility
    const tagsMatch = rawContent.match(/const tags\s*=\s*\[([^\]]+)\]/);
    const categoryMatch = rawContent.match(/const category\s*=\s*["']([^"']+)["']/);

    let tags: string[] = [];
    if (tagsMatch) {
      // Parse the tags array - extract strings from the array literal
      tags = tagsMatch[1]
        .split(',')
        .map(t => t.trim().replace(/^["']|["']$/g, ''))
        .filter(t => t.length > 0);
    } else if (categoryMatch) {
      // Backwards compatibility: single category becomes single-item tags array
      tags = [categoryMatch[1]];
    }

    // Get the image from the glob
    let image: ImageMetadata | null = null;
    if (imageMatch) {
      const imagePath = `/src/images/${imageMatch[1]}`;
      image = allImages[imagePath]?.default || null;
    }

    return {
      slug,
      title: titleMatch?.[1] || slug,
      description: descriptionMatch?.[1] || '',
      tags: tags.length > 0 ? tags : ['Uncategorized'],
      image,
      publishDate: publishDateMatch?.[1] || null,
      helpfulCount: ratingsMap[slug] || 0,
    };
  })
  // Default sort: newest first (articles with dates), then alphabetical for undated
  .sort((a, b) => {
    // If both have dates, sort by date (newest first)
    if (a.publishDate && b.publishDate) {
      return b.publishDate.localeCompare(a.publishDate);
    }
    // Articles with dates come before those without
    if (a.publishDate && !b.publishDate) return -1;
    if (!a.publishDate && b.publishDate) return 1;
    // Fall back to alphabetical for articles without dates
    return a.title.localeCompare(b.title);
  });

// Get unique tags for filtering (sorted alphabetically)
const allTags = [...new Set(articles.flatMap(a => a.tags))].sort();

// Category colors for badges
const categoryColors: Record<string, string> = {
  'Financial Aid': 'bg-green-100 text-green-800',
  'Graduate School': 'bg-purple-100 text-purple-800',
  'College Admissions': 'bg-blue-100 text-blue-800',
  'Kindergarten': 'bg-yellow-100 text-yellow-800',
  'Preschool': 'bg-pink-100 text-pink-800',
  'Elementary School': 'bg-orange-100 text-orange-800',
  'Middle School': 'bg-teal-100 text-teal-800',
  'High School': 'bg-indigo-100 text-indigo-800',
  'Charter Schools': 'bg-red-100 text-red-800',
  'Magnet Schools': 'bg-cyan-100 text-cyan-800',
  'School Types': 'bg-slate-100 text-slate-800',
  'School Choice': 'bg-amber-100 text-amber-800',
  'Special Education': 'bg-violet-100 text-violet-800',
  'Mental Health': 'bg-rose-100 text-rose-800',
  'Vocational Education': 'bg-lime-100 text-lime-800',
  'Future of Education': 'bg-sky-100 text-sky-800',
  "Children's Health": 'bg-emerald-100 text-emerald-800',
};
---

<Layout title={title} description={description}>
  <div class="container py-8">
    <!-- Page Header -->
    <div class="max-w-3xl mb-10">
      <nav class="text-sm text-gray-500 mb-4">
        <a href="/" class="hover:text-brand-blue">Home</a>
        <span class="mx-2">/</span>
        <span class="text-gray-700">Education Articles</span>
      </nav>
      <h1 class="text-4xl font-bold text-gray-900 mb-4">Education Articles</h1>
      <p class="text-xl text-gray-600">
        Expert guides and insights to help you navigate school choices, college admissions, financial aid, and your child's education journey.
      </p>
    </div>

    <!-- Filter and Sort Controls -->
    <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <!-- Tag Filter -->
      <div class="flex flex-wrap gap-2">
        <button
          class="tag-filter px-3 py-1.5 rounded-full text-sm font-medium bg-brand-blue text-white transition-colors"
          data-tag="all"
        >
          All Articles ({articles.length})
        </button>
        {allTags.map(tag => {
          const count = articles.filter(a => a.tags.includes(tag)).length;
          return (
            <button
              class="tag-filter px-3 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors"
              data-tag={tag}
            >
              {tag} ({count})
            </button>
          );
        })}
      </div>

      <!-- Sort Dropdown -->
      <div class="flex items-center gap-2 shrink-0">
        <label for="sort-select" class="text-sm text-gray-600">Sort by:</label>
        <select
          id="sort-select"
          class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent cursor-pointer"
        >
          <option value="newest">Newest</option>
          <option value="popular">Most Popular</option>
          <option value="az">A-Z</option>
        </select>
      </div>
    </div>

    <!-- Articles Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="articles-grid">
      {articles.map((article, index) => (
        <article
          class="article-card bg-white rounded-lg border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow group"
          data-tags={JSON.stringify(article.tags)}
          data-title={article.title}
          data-date={article.publishDate || ''}
          data-helpful={article.helpfulCount}
        >
          <a href={`/education-articles/${article.slug}`} class="block">
            <div class="aspect-[16/9] overflow-hidden bg-gray-100">
              {article.image ? (
                <img
                  src={article.image.src}
                  alt={article.title}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                />
              ) : (
                <div class="w-full h-full flex items-center justify-center bg-gray-200">
                  <span class="text-gray-400 text-sm">No image</span>
                </div>
              )}
            </div>
            <div class="p-4">
              <div class="flex flex-wrap items-center gap-1.5 mb-2">
                {article.tags.map(tag => (
                  <span class={`px-2 py-0.5 rounded text-xs font-medium ${categoryColors[tag] || 'bg-gray-100 text-gray-800'}`}>
                    {tag}
                  </span>
                ))}
              </div>
              <h2 class="text-lg font-bold text-gray-900 mb-2 leading-tight group-hover:text-brand-blue transition-colors">
                {article.title}
              </h2>
              <p class="text-sm text-gray-600">
                {article.description}
              </p>
            </div>
          </a>
        </article>
      ))}
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="hidden text-center py-12">
      <p class="text-gray-500 text-lg">No articles found in this category.</p>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const filterButtons = document.querySelectorAll('.tag-filter');
      const articlesGrid = document.getElementById('articles-grid');
      const noResults = document.getElementById('no-results');
      const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;

      let currentTag = 'all';

      // Check URL for tag parameter on load
      const urlParams = new URLSearchParams(window.location.search);
      const tagFromUrl = urlParams.get('tag');
      if (tagFromUrl) {
        currentTag = tagFromUrl;
        // Find and activate the matching button
        filterButtons.forEach(btn => {
          const btnTag = btn.getAttribute('data-tag');
          if (btnTag === tagFromUrl) {
            btn.classList.remove('bg-gray-100', 'text-gray-700');
            btn.classList.add('bg-brand-blue', 'text-white');
          } else {
            btn.classList.remove('bg-brand-blue', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700');
          }
        });
        // Apply initial filter
        setTimeout(() => filterArticles(), 0);
      }

      // Get all article cards as an array for sorting
      function getArticleCards(): HTMLElement[] {
        return Array.from(document.querySelectorAll('.article-card')) as HTMLElement[];
      }

      // Filter articles based on selected tag
      function filterArticles() {
        const cards = getArticleCards();
        let visibleCount = 0;

        cards.forEach(card => {
          const tagsJson = card.getAttribute('data-tags');
          const cardTags: string[] = tagsJson ? JSON.parse(tagsJson) : [];
          if (currentTag === 'all' || cardTags.includes(currentTag)) {
            card.style.display = 'block';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        // Show/hide no results message
        if (noResults) {
          noResults.classList.toggle('hidden', visibleCount > 0);
        }
      }

      // Sort articles based on selected option
      function sortArticles(sortBy: string) {
        const cards = getArticleCards();

        cards.sort((a, b) => {
          switch (sortBy) {
            case 'newest': {
              const dateA = a.getAttribute('data-date') || '';
              const dateB = b.getAttribute('data-date') || '';
              // Articles with dates come first, sorted newest to oldest
              if (dateA && dateB) return dateB.localeCompare(dateA);
              if (dateA && !dateB) return -1;
              if (!dateA && dateB) return 1;
              // Fall back to title for undated articles
              const titleA = a.getAttribute('data-title') || '';
              const titleB = b.getAttribute('data-title') || '';
              return titleA.localeCompare(titleB);
            }
            case 'popular': {
              const helpfulA = parseInt(a.getAttribute('data-helpful') || '0', 10);
              const helpfulB = parseInt(b.getAttribute('data-helpful') || '0', 10);
              // Sort by helpful count descending, then by title
              if (helpfulB !== helpfulA) return helpfulB - helpfulA;
              const titleA = a.getAttribute('data-title') || '';
              const titleB = b.getAttribute('data-title') || '';
              return titleA.localeCompare(titleB);
            }
            case 'az': {
              const titleA = a.getAttribute('data-title') || '';
              const titleB = b.getAttribute('data-title') || '';
              return titleA.localeCompare(titleB);
            }
            default:
              return 0;
          }
        });

        // Re-append sorted cards to the grid
        if (articlesGrid) {
          cards.forEach(card => articlesGrid.appendChild(card));
        }

        // Re-apply filter after sorting
        filterArticles();
      }

      // Handle tag filter clicks
      filterButtons.forEach(button => {
        button.addEventListener('click', () => {
          const selectedTag = button.getAttribute('data-tag') || 'all';
          currentTag = selectedTag;

          // Update active button styles
          filterButtons.forEach(btn => {
            btn.classList.remove('bg-brand-blue', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700');
          });
          button.classList.remove('bg-gray-100', 'text-gray-700');
          button.classList.add('bg-brand-blue', 'text-white');

          filterArticles();
        });
      });

      // Handle sort selection
      if (sortSelect) {
        sortSelect.addEventListener('change', () => {
          sortArticles(sortSelect.value);
        });
      }
    });
  </script>
</Layout>

