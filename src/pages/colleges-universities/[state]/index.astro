---
import Layout from '@/layouts/Layout.astro';
import NewsletterSignup from '@/components/NewsletterSignup.astro';

const { state } = Astro.params;
const db = Astro.locals.runtime.env.DB;

// State name to abbreviation mapping
const stateMap: Record<string, string> = {
  'alabama': 'AL', 'alaska': 'AK', 'arizona': 'AZ', 'arkansas': 'AR',
  'california': 'CA', 'colorado': 'CO', 'connecticut': 'CT', 'delaware': 'DE',
  'district-of-columbia': 'DC', 'florida': 'FL', 'georgia': 'GA', 'hawaii': 'HI',
  'idaho': 'ID', 'illinois': 'IL', 'indiana': 'IN', 'iowa': 'IA',
  'kansas': 'KS', 'kentucky': 'KY', 'louisiana': 'LA', 'maine': 'ME',
  'maryland': 'MD', 'massachusetts': 'MA', 'michigan': 'MI', 'minnesota': 'MN',
  'mississippi': 'MS', 'missouri': 'MO', 'montana': 'MT', 'nebraska': 'NE',
  'nevada': 'NV', 'new-hampshire': 'NH', 'new-jersey': 'NJ', 'new-mexico': 'NM',
  'new-york': 'NY', 'north-carolina': 'NC', 'north-dakota': 'ND', 'ohio': 'OH',
  'oklahoma': 'OK', 'oregon': 'OR', 'pennsylvania': 'PA', 'puerto-rico': 'PR',
  'rhode-island': 'RI', 'south-carolina': 'SC', 'south-dakota': 'SD',
  'tennessee': 'TN', 'texas': 'TX', 'utah': 'UT', 'vermont': 'VT',
  'virginia': 'VA', 'washington': 'WA', 'west-virginia': 'WV',
  'wisconsin': 'WI', 'wyoming': 'WY'
};

const stateAbbr = stateMap[state || ''] || state?.toUpperCase();

// State abbreviation to full name mapping
const stateNames: Record<string, string> = {
  'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
  'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
  'DC': 'District of Columbia', 'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii',
  'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
  'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine',
  'MD': 'Maryland', 'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota',
  'MS': 'Mississippi', 'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska',
  'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico',
  'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
  'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'PR': 'Puerto Rico',
  'RI': 'Rhode Island', 'SC': 'South Carolina', 'SD': 'South Dakota',
  'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
  'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia',
  'WI': 'Wisconsin', 'WY': 'Wyoming'
};

const stateName = stateNames[stateAbbr || ''] || state;

if (!stateAbbr || !stateName) {
  return Astro.redirect('/404');
}

// Get all colleges in this state
const collegesResult = await db.prepare(`
  SELECT id, institution_name, page_name, city, sector, institution_control,
         is_four_year, is_two_year, total_enrollment, tuition_in_state
  FROM colleges
  WHERE state_abbr = ? AND active = 1
  ORDER BY institution_name
`).bind(stateAbbr).all();

const colleges = collegesResult.results;

// Group by city
const collegesByCity: Record<string, any[]> = {};
for (const college of colleges) {
  const city = college.city || 'Other';
  if (!collegesByCity[city]) {
    collegesByCity[city] = [];
  }
  collegesByCity[city].push(college);
}

// Sort cities alphabetically
const sortedCities = Object.keys(collegesByCity).sort();

// Get first letter groups for A-Z navigation
const letterGroups: Record<string, string[]> = {};
for (const city of sortedCities) {
  const letter = city.charAt(0).toUpperCase();
  if (!letterGroups[letter]) {
    letterGroups[letter] = [];
  }
  letterGroups[letter].push(city);
}

// All US states for sidebar
const allStates = [
  { name: 'Alabama', slug: 'alabama' },
  { name: 'Alaska', slug: 'alaska' },
  { name: 'Arizona', slug: 'arizona' },
  { name: 'Arkansas', slug: 'arkansas' },
  { name: 'California', slug: 'california' },
  { name: 'Colorado', slug: 'colorado' },
  { name: 'Connecticut', slug: 'connecticut' },
  { name: 'Delaware', slug: 'delaware' },
  { name: 'District of Columbia', slug: 'district-of-columbia' },
  { name: 'Florida', slug: 'florida' },
  { name: 'Georgia', slug: 'georgia' },
  { name: 'Hawaii', slug: 'hawaii' },
  { name: 'Idaho', slug: 'idaho' },
  { name: 'Illinois', slug: 'illinois' },
  { name: 'Indiana', slug: 'indiana' },
  { name: 'Iowa', slug: 'iowa' },
  { name: 'Kansas', slug: 'kansas' },
  { name: 'Kentucky', slug: 'kentucky' },
  { name: 'Louisiana', slug: 'louisiana' },
  { name: 'Maine', slug: 'maine' },
  { name: 'Maryland', slug: 'maryland' },
  { name: 'Massachusetts', slug: 'massachusetts' },
  { name: 'Michigan', slug: 'michigan' },
  { name: 'Minnesota', slug: 'minnesota' },
  { name: 'Mississippi', slug: 'mississippi' },
  { name: 'Missouri', slug: 'missouri' },
  { name: 'Montana', slug: 'montana' },
  { name: 'Nebraska', slug: 'nebraska' },
  { name: 'Nevada', slug: 'nevada' },
  { name: 'New Hampshire', slug: 'new-hampshire' },
  { name: 'New Jersey', slug: 'new-jersey' },
  { name: 'New Mexico', slug: 'new-mexico' },
  { name: 'New York', slug: 'new-york' },
  { name: 'North Carolina', slug: 'north-carolina' },
  { name: 'North Dakota', slug: 'north-dakota' },
  { name: 'Ohio', slug: 'ohio' },
  { name: 'Oklahoma', slug: 'oklahoma' },
  { name: 'Oregon', slug: 'oregon' },
  { name: 'Pennsylvania', slug: 'pennsylvania' },
  { name: 'Puerto Rico', slug: 'puerto-rico' },
  { name: 'Rhode Island', slug: 'rhode-island' },
  { name: 'South Carolina', slug: 'south-carolina' },
  { name: 'South Dakota', slug: 'south-dakota' },
  { name: 'Tennessee', slug: 'tennessee' },
  { name: 'Texas', slug: 'texas' },
  { name: 'Utah', slug: 'utah' },
  { name: 'Vermont', slug: 'vermont' },
  { name: 'Virginia', slug: 'virginia' },
  { name: 'Washington', slug: 'washington' },
  { name: 'West Virginia', slug: 'west-virginia' },
  { name: 'Wisconsin', slug: 'wisconsin' },
  { name: 'Wyoming', slug: 'wyoming' },
];

function getInstitutionType(college: any): string {
  const parts = [];
  if (college.institution_control) parts.push(college.institution_control);
  if (college.is_four_year) parts.push('4-year');
  else if (college.is_two_year) parts.push('2-year');
  return parts.join(', ') || college.sector || '';
}
---

<Layout title={`Colleges & Universities in ${stateName}`} description={`Browse ${colleges.length} colleges and universities in ${stateName}. Find admissions info, tuition costs, programs, and more.`}>
  <div class="container py-5">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-4">
      <ol class="flex flex-wrap items-center gap-2 text-gray-600">
        <li><a href="/" class="hover:text-brand-blue">Home</a></li>
        <li class="text-gray-400">/</li>
        <li><a href="/colleges-universities" class="hover:text-brand-blue">Colleges</a></li>
        <li class="text-gray-400">/</li>
        <li class="text-gray-900 font-medium">{stateName}</li>
      </ol>
    </nav>

    <h1 class="text-brand-green-text mb-2">Colleges & Universities in {stateName}</h1>
    <p class="fs-14 text-gray-500 mb-5">{colleges.length} institution{colleges.length !== 1 ? 's' : ''} found</p>

    <div class="flex flex-col lg:flex-row gap-5">
      <!-- Main Content -->
      <div class="lg:w-2/3">
        <!-- A-Z Navigation -->
        <div class="box-rounded mb-5">
          <div class="flex flex-wrap gap-2">
            {['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'].map((letter) => (
              letterGroups[letter] ? (
                <a href={`#letter-${letter}`} class="w-8 h-8 flex items-center justify-center bg-brand-blue text-white rounded font-bold text-sm hover:bg-brand-green transition-colors">
                  {letter}
                </a>
              ) : (
                <span class="w-8 h-8 flex items-center justify-center bg-gray-200 text-gray-400 rounded font-bold text-sm">
                  {letter}
                </span>
              )
            ))}
          </div>
        </div>

        <!-- Colleges by City -->
        {Object.keys(letterGroups).sort().map((letter) => (
          <div id={`letter-${letter}`} class="mb-6">
            <h2 class="text-brand-blue text-xl mb-3 sticky top-0 bg-white py-2 border-b border-gray-200">{letter}</h2>
            {letterGroups[letter].map((city) => (
              <div class="mb-4">
                <h3 class="text-brand-green-text font-bold fs-14 mb-2">{city}</h3>
                <div class="space-y-2">
                  {collegesByCity[city].map((college: any) => (
                    <a href={`/colleges-universities/${state}/${college.page_name}`} class="block p-3 border border-gray-200 rounded hover:border-brand-blue hover:bg-gray-50 transition-colors">
                      <div class="flex justify-between items-start">
                        <div>
                          <span class="text-brand-blue font-medium">{college.institution_name}</span>
                          {getInstitutionType(college) && (
                            <span class="text-gray-500 fs-13 ml-2">({getInstitutionType(college)})</span>
                          )}
                        </div>
                        {college.tuition_in_state && (
                          <span class="text-gray-500 fs-13">${college.tuition_in_state.toLocaleString()}</span>
                        )}
                      </div>
                    </a>
                  ))}
                </div>
              </div>
            ))}
          </div>
        ))}
      </div>

      <!-- Sidebar -->
      <div class="lg:w-1/3">
        <div class="box-rounded bg-lt-blue mb-4">
          <h3 class="text-brand-blue mb-3">Quick Jump</h3>
          <select
            class="input w-full"
            onchange="if(this.value) window.location.href=this.value"
          >
            <option value="">-- Select a State --</option>
            {allStates.map((s) => (
              <option value={`/colleges-universities/${s.slug}`} selected={s.slug === state}>
                {s.name}
              </option>
            ))}
          </select>
        </div>

        <!-- Ad Placeholder -->
        <div class="box-rounded mb-4">
          <div class="bg-gray-100 h-[280px] flex items-center justify-center text-gray-400 fs-13">
            Advertisement
          </div>
        </div>

        <div class="box-rounded mb-4">
          <h3 class="text-brand-blue mb-3">Browse by State</h3>
          <div class="max-h-[300px] overflow-y-auto fs-13">
            <ul class="list-none m-0 p-0">
              {allStates.map((s, index) => (
                <li class={`py-1 ${s.slug === state ? 'font-bold' : ''}`}>
                  <a href={`/colleges-universities/${s.slug}`} class="text-brand-blue hover:underline">
                    {s.name}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </div>

        <NewsletterSignup preselected={['college', 'university']} />
      </div>
    </div>
  </div>
</Layout>
