---
import Layout from '@/layouts/Layout.astro';
import NewsletterSignup from '@/components/NewsletterSignup.astro';

// Get all grants from database
const runtime = Astro.locals.runtime;
let allGrants: any[] = [];

if (runtime?.env?.DB) {
  try {
    const result = await runtime.env.DB.prepare(`
      SELECT * FROM federal_grants
      ORDER BY cfda_number
    `).all();
    allGrants = result.results || [];
  } catch (e) {
    console.error('Error fetching grants:', e);
  }
}

function formatCfdaSlug(cfda: string): string {
  return cfda.replace('.', '-');
}

// Strip parentheses from popular_name (SAM.gov data includes them)
function cleanPopularName(name: string | null): string | null {
  if (!name) return null;
  return name.replace(/^\((.+)\)$/, '$1').trim();
}

// Group grants by category
const studentAid = allGrants.filter(g => g.is_student_aid);
const higherEd = allGrants.filter(g => g.is_higher_ed && !g.is_student_aid);
const k12 = allGrants.filter(g => g.is_k12);
const careerTech = allGrants.filter(g => g.is_career_tech);
const specialEd = allGrants.filter(g => g.is_special_ed);
---

<Layout title="All Federal Education Grants - Complete List" description="Browse all 112 federal education grant programs from the U.S. Department of Education, including student aid, higher education, K-12, and career/technical education grants.">
  <div class="container py-5">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-4">
      <ol class="flex flex-wrap items-center gap-2 text-gray-600">
        <li><a href="/" class="hover:text-brand-blue">Home</a></li>
        <li class="text-gray-400">/</li>
        <li><a href="/financial-aid" class="hover:text-brand-blue">Financial Aid</a></li>
        <li class="text-gray-400">/</li>
        <li><a href="/financial-aid/grants" class="hover:text-brand-blue">Grants</a></li>
        <li class="text-gray-400">/</li>
        <li class="text-gray-900 font-medium">All Grants</li>
      </ol>
    </nav>

    <h1 class="text-brand-green-text mb-2">All Federal Education Grants</h1>
    <p class="fs-14 text-gray-500 mb-5">
      Complete list of {allGrants.length} federal grant programs administered by the U.S. Department of Education.
    </p>

    <div class="flex flex-col lg:flex-row gap-5">
      <!-- Main Content -->
      <div class="lg:w-2/3">
        <!-- Filter by Category -->
        <div class="box-rounded mb-5 bg-lt-blue">
          <h2 class="text-brand-blue mb-3">Browse by Category</h2>
          <div class="flex flex-wrap gap-2">
            <a href="#student-aid" class="bg-white px-3 py-1.5 rounded border border-gray-200 hover:border-brand-blue fs-13 transition-colors">
              Student Financial Aid ({studentAid.length})
            </a>
            <a href="#higher-ed" class="bg-white px-3 py-1.5 rounded border border-gray-200 hover:border-brand-blue fs-13 transition-colors">
              Higher Education ({higherEd.length})
            </a>
            <a href="#k12" class="bg-white px-3 py-1.5 rounded border border-gray-200 hover:border-brand-blue fs-13 transition-colors">
              K-12 Education ({k12.length})
            </a>
            <a href="#career-tech" class="bg-white px-3 py-1.5 rounded border border-gray-200 hover:border-brand-blue fs-13 transition-colors">
              Career & Technical ({careerTech.length})
            </a>
            <a href="#special-ed" class="bg-white px-3 py-1.5 rounded border border-gray-200 hover:border-brand-blue fs-13 transition-colors">
              Special Education ({specialEd.length})
            </a>
          </div>
        </div>

        <!-- Student Financial Aid -->
        {studentAid.length > 0 && (
          <div id="student-aid" class="box-rounded mb-5">
            <h2 class="text-brand-blue text-xl mb-4">Student Financial Aid ({studentAid.length})</h2>
            <div class="space-y-3">
              {studentAid.map((grant) => (
                <a
                  href={`/financial-aid/grants/${formatCfdaSlug(grant.cfda_number)}`}
                  class="flex items-center justify-between p-3 border border-gray-200 rounded hover:border-brand-blue transition-colors block"
                >
                  <div>
                    <span class="text-brand-green-text font-medium">{cleanPopularName(grant.popular_name) || grant.title}</span>
                    <span class="text-gray-400 fs-12 ml-2">(CFDA {grant.cfda_number})</span>
                    {grant.popular_name && (
                      <p class="text-gray-500 fs-12">{grant.title}</p>
                    )}
                  </div>
                  <span class="text-brand-blue fs-13">&rarr;</span>
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- Higher Education -->
        {higherEd.length > 0 && (
          <div id="higher-ed" class="box-rounded mb-5">
            <h2 class="text-brand-blue text-xl mb-4">Higher Education ({higherEd.length})</h2>
            <div class="space-y-2">
              {higherEd.map((grant) => (
                <a
                  href={`/financial-aid/grants/${formatCfdaSlug(grant.cfda_number)}`}
                  class="flex items-center justify-between p-2 border-b border-gray-100 hover:bg-gray-50 transition-colors block"
                >
                  <div>
                    <span class="text-gray-800 fs-14">{grant.title}</span>
                    <span class="text-gray-400 fs-11 ml-2">(CFDA {grant.cfda_number})</span>
                  </div>
                  <span class="text-brand-blue fs-13">&rarr;</span>
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- K-12 Education -->
        {k12.length > 0 && (
          <div id="k12" class="box-rounded mb-5">
            <h2 class="text-brand-blue text-xl mb-4">K-12 Education ({k12.length})</h2>
            <div class="space-y-2">
              {k12.map((grant) => (
                <a
                  href={`/financial-aid/grants/${formatCfdaSlug(grant.cfda_number)}`}
                  class="flex items-center justify-between p-2 border-b border-gray-100 hover:bg-gray-50 transition-colors block"
                >
                  <div>
                    <span class="text-gray-800 fs-14">{grant.title}</span>
                    <span class="text-gray-400 fs-11 ml-2">(CFDA {grant.cfda_number})</span>
                  </div>
                  <span class="text-brand-blue fs-13">&rarr;</span>
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- Career & Technical Education -->
        {careerTech.length > 0 && (
          <div id="career-tech" class="box-rounded mb-5">
            <h2 class="text-brand-blue text-xl mb-4">Career & Technical Education ({careerTech.length})</h2>
            <div class="space-y-2">
              {careerTech.map((grant) => (
                <a
                  href={`/financial-aid/grants/${formatCfdaSlug(grant.cfda_number)}`}
                  class="flex items-center justify-between p-2 border-b border-gray-100 hover:bg-gray-50 transition-colors block"
                >
                  <div>
                    <span class="text-gray-800 fs-14">{grant.title}</span>
                    <span class="text-gray-400 fs-11 ml-2">(CFDA {grant.cfda_number})</span>
                  </div>
                  <span class="text-brand-blue fs-13">&rarr;</span>
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- Special Education -->
        {specialEd.length > 0 && (
          <div id="special-ed" class="box-rounded mb-5">
            <h2 class="text-brand-blue text-xl mb-4">Special Education ({specialEd.length})</h2>
            <div class="space-y-2">
              {specialEd.map((grant) => (
                <a
                  href={`/financial-aid/grants/${formatCfdaSlug(grant.cfda_number)}`}
                  class="flex items-center justify-between p-2 border-b border-gray-100 hover:bg-gray-50 transition-colors block"
                >
                  <div>
                    <span class="text-gray-800 fs-14">{grant.title}</span>
                    <span class="text-gray-400 fs-11 ml-2">(CFDA {grant.cfda_number})</span>
                  </div>
                  <span class="text-brand-blue fs-13">&rarr;</span>
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- All Grants Alphabetical -->
        <div class="box-rounded mb-5">
          <h2 class="text-brand-blue text-xl mb-4">All Programs by CFDA Number</h2>
          <div class="space-y-1 max-h-[600px] overflow-y-auto">
            {allGrants.map((grant) => (
              <a
                href={`/financial-aid/grants/${formatCfdaSlug(grant.cfda_number)}`}
                class="flex items-center justify-between p-2 hover:bg-gray-50 transition-colors block fs-13"
              >
                <div class="flex items-center gap-2">
                  <span class="text-brand-blue font-mono">CFDA {grant.cfda_number}</span>
                  <span class="text-gray-700">{grant.title}</span>
                </div>
                <span class="text-gray-400">&rarr;</span>
              </a>
            ))}
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="lg:w-1/3">
        <!-- Summary Stats -->
        <div class="box-rounded bg-lt-blue mb-4">
          <h3 class="text-brand-blue mb-3">Grant Statistics</h3>
          <dl class="space-y-2 fs-14">
            <div class="flex justify-between">
              <dt class="text-gray-600">Total Programs</dt>
              <dd class="font-bold text-gray-900">{allGrants.length}</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-600">Student Aid</dt>
              <dd class="font-medium text-gray-900">{studentAid.length}</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-600">Higher Education</dt>
              <dd class="font-medium text-gray-900">{higherEd.length}</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-600">K-12 Education</dt>
              <dd class="font-medium text-gray-900">{k12.length}</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-600">Career & Technical</dt>
              <dd class="font-medium text-gray-900">{careerTech.length}</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-600">Special Education</dt>
              <dd class="font-medium text-gray-900">{specialEd.length}</dd>
            </div>
          </dl>
        </div>

        <!-- Quick Links -->
        <div class="box-rounded mb-4">
          <h3 class="text-brand-blue mb-3">Quick Links</h3>
          <ul class="space-y-2 fs-14">
            <li>
              <a href="/financial-aid/grants" class="text-brand-blue hover:underline">&larr; Back to Grants Overview</a>
            </li>
            <li>
              <a href="/financial-aid" class="text-brand-blue hover:underline">&rarr; Financial Aid Home</a>
            </li>
            <li>
              <a href="https://sam.gov/content/assistance-listings" target="_blank" rel="noopener" class="text-brand-blue hover:underline">&rarr; SAM.gov Assistance Listings</a>
            </li>
          </ul>
        </div>

        <!-- Ad Placeholder -->
        <div class="box-rounded mb-4">
          <div class="bg-gray-100 h-[280px] flex items-center justify-center text-gray-400 fs-13">
            Advertisement
          </div>
        </div>

        <!-- Data Source -->
        <div class="box-rounded mb-4 bg-gray-50">
          <h3 class="text-gray-700 mb-2 fs-14">Data Source</h3>
          <p class="text-gray-500 fs-12">
            Grant information from <a href="https://sam.gov/content/assistance-listings" target="_blank" rel="noopener" class="text-brand-blue hover:underline">SAM.gov Assistance Listings</a>
            (formerly CFDA). Data updated December 2024.
          </p>
        </div>

        <!-- Newsletter -->
        <NewsletterSignup preselected={['financial-aid']} />
      </div>
    </div>
  </div>
</Layout>
