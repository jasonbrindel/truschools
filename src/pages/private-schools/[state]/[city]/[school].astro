---
import Layout from '@/layouts/Layout.astro';
import NewsletterSignup from '@/components/NewsletterSignup.astro';

const { state, city, school } = Astro.params;

// Get database connection
const db = Astro.locals.runtime.env.DB;

// Get state info
const stateResult = await db.prepare(
  'SELECT * FROM states WHERE slug = ?'
).bind(state).first();

if (!stateResult) {
  return Astro.redirect('/404');
}

// Slugify function to match city
function slugify(text: string): string {
  return text.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
}

// Find the school - match by page_name and must be private (is_public = 0)
const schoolResult = await db.prepare(`
  SELECT s.*, st.name as state_name, st.slug as state_slug
  FROM schools s
  JOIN states st ON s.state = st.abbr
  WHERE s.is_public = 0
    AND st.slug = ?
    AND (
      s.page_name = ?
      OR s.page_name LIKE ?
    )
  LIMIT 1
`).bind(state, school, `${school}%`).first();

if (!schoolResult) {
  return Astro.redirect('/404');
}

// Type the school data
const schoolData = schoolResult as any;

// Format phone number
function formatPhone(phone: string | null): string {
  if (!phone) return '';
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 10) {
    return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
  }
  return phone;
}

// Format grade range
function formatGradeRange(low: string | null, high: string | null): string {
  if (!low && !high) return 'N/A';

  const formatGrade = (g: string) => {
    if (g === 'PK') return 'Pre-K';
    if (g === 'KG' || g === 'K') return 'Kindergarten';
    if (g === '01' || g === '1') return '1st Grade';
    if (g === '02' || g === '2') return '2nd Grade';
    if (g === '03' || g === '3') return '3rd Grade';
    const num = parseInt(g);
    if (!isNaN(num)) return `${num}th Grade`;
    return g;
  };

  if (low === high) return formatGrade(low!);
  return `${formatGrade(low!)} - ${formatGrade(high!)}`;
}

// Get school type label
function getSchoolType(school: any): string {
  const types = ['Private School'];
  if (school.religious_affiliation) types.push(school.religious_affiliation);
  return types.join(' | ');
}

// Get school level label
function getSchoolLevel(school: any): string {
  const levels = [];
  if (school.is_preschool) levels.push('Preschool');
  if (school.is_kindergarten) levels.push('Kindergarten');
  if (school.is_elementary) levels.push('Elementary');
  if (school.is_middle_school) levels.push('Middle');
  if (school.is_high_school) levels.push('High');
  return levels.length > 0 ? levels.join('/') + ' School' : 'K-12 School';
}

// Get locale description from NCES locale code
function getLocaleDescription(locale: string | null): string {
  if (!locale) return 'N/A';
  const localeMap: Record<string, string> = {
    '11': 'City - Large',
    '12': 'City - Midsize',
    '13': 'City - Small',
    '21': 'Suburban - Large',
    '22': 'Suburban - Midsize',
    '23': 'Suburban - Small',
    '31': 'Town - Fringe',
    '32': 'Town - Distant',
    '33': 'Town - Remote',
    '41': 'Rural - Fringe',
    '42': 'Rural - Distant',
    '43': 'Rural - Remote'
  };
  return localeMap[locale] || locale;
}

// Format number with commas
function formatNumber(num: number | null): string {
  if (num === null || num === undefined) return 'N/A';
  return num.toLocaleString();
}

// City name formatted
const cityName = schoolData.city.split(' ').map((w: string) =>
  w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()
).join(' ');

// Get nearby private schools
const nearbySchools = await db.prepare(`
  SELECT school_name, page_name, city, is_elementary, is_middle_school, is_high_school, religious_affiliation
  FROM schools
  WHERE state = ?
    AND LOWER(city) = LOWER(?)
    AND id != ?
    AND is_public = 0
    AND active = 1
  LIMIT 5
`).bind(schoolData.state, schoolData.city, schoolData.id).all();

// Get census data for community section
const zipCode = schoolData.zip?.substring(0, 5);
let censusEconomic = null;
let censusPopulation = null;
let censusSocial = null;
let censusHousing = null;

if (zipCode) {
  const [econ, pop, social, housing] = await Promise.all([
    db.prepare('SELECT * FROM census_economic WHERE zcta = ?').bind(zipCode).first(),
    db.prepare('SELECT * FROM census_population WHERE zcta = ?').bind(zipCode).first(),
    db.prepare('SELECT * FROM census_social WHERE zcta = ?').bind(zipCode).first(),
    db.prepare('SELECT * FROM census_housing WHERE zcta = ?').bind(zipCode).first()
  ]);
  censusEconomic = econ as any;
  censusPopulation = pop as any;
  censusSocial = social as any;
  censusHousing = housing as any;
}

// Format currency
function formatCurrency(num: number | null): string {
  if (num === null || num === undefined) return 'N/A';
  return '$' + num.toLocaleString();
}

// Format percentage
function formatPercent(num: number | null): string {
  if (num === null || num === undefined) return 'N/A';
  return num.toFixed(1) + '%';
}

// Build page title and description
const pageTitle = `${schoolData.school_name} - Private School in ${cityName}, ${schoolData.state_name}`;
const pageDescription = `${schoolData.school_name} is a ${getSchoolType(schoolData).toLowerCase()} in ${cityName}, ${schoolData.state_name}. View contact info, enrollment, grades, and more.`;
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="container py-5">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-4">
      <ol class="flex flex-wrap items-center gap-2 text-gray-600">
        <li><a href="/" class="hover:text-brand-blue">Home</a></li>
        <li class="text-gray-400">/</li>
        <li><a href="/private-schools" class="hover:text-brand-blue">Private Schools</a></li>
        <li class="text-gray-400">/</li>
        <li><a href={`/private-schools/${state}`} class="hover:text-brand-blue">{schoolData.state_name}</a></li>
        <li class="text-gray-400">/</li>
        <li><a href={`/private-schools/${state}/${city}`} class="hover:text-brand-blue">{cityName}</a></li>
        <li class="text-gray-400">/</li>
        <li class="text-gray-900 font-medium">{schoolData.school_name}</li>
      </ol>
    </nav>

    <div class="flex flex-col lg:flex-row gap-5">
      <!-- Main Content -->
      <div class="lg:w-[728px] lg:flex-shrink-0">
        <!-- School Header -->
        <div class="box-rounded mb-5">
          <h1 class="text-brand-green-text text-2xl mb-2">{schoolData.school_name}</h1>
          <p class="text-gray-600 fs-14 mb-4">
            {getSchoolType(schoolData)} | {getSchoolLevel(schoolData)} | {formatGradeRange(schoolData.low_grade, schoolData.high_grade)} | {formatNumber(schoolData.total_students)} students
          </p>

          <!-- Contact Info -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <h3 class="text-brand-blue fs-14 font-bold mb-1">Address</h3>
              <p class="fs-13 mb-0">
                {schoolData.address}<br />
                {cityName}, {schoolData.state} {schoolData.zip}
              </p>
            </div>
            <div>
              {schoolData.phone && (
                <div class="mb-3">
                  <h3 class="text-brand-blue fs-14 font-bold mb-1">Phone</h3>
                  <p class="fs-13 mb-0">
                    <a href={`tel:${schoolData.phone.replace(/\D/g, '')}`}>{formatPhone(schoolData.phone)}</a>
                  </p>
                </div>
              )}
              {schoolData.website && (
                <div>
                  <h3 class="text-brand-blue fs-14 font-bold mb-1">Website</h3>
                  <p class="fs-13 mb-0">
                    <a href={schoolData.website.startsWith('http') ? schoolData.website : `https://${schoolData.website}`} target="_blank" rel="noopener noreferrer">
                      Visit Website
                    </a>
                  </p>
                </div>
              )}
            </div>
          </div>

          {schoolData.district_name && (
            <div class="border-t border-dotted border-[#c1c1c1] pt-3">
              <h3 class="text-brand-blue fs-14 font-bold mb-1">School Association</h3>
              <p class="fs-13 mb-0">{schoolData.district_name}</p>
            </div>
          )}
        </div>

        <!-- School Details -->
        <div class="box-rounded mb-5">
          <h2 class="text-brand-blue mb-4">School Details</h2>

          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div class="p-3 bg-lt-blue rounded">
              <p class="fs-12 text-gray-500 mb-1">Total Students</p>
              <p class="text-lg font-bold text-brand-green-text mb-0">{formatNumber(schoolData.total_students)}</p>
            </div>
            <div class="p-3 bg-lt-blue rounded">
              <p class="fs-12 text-gray-500 mb-1">Grades</p>
              <p class="text-lg font-bold text-brand-green-text mb-0">{formatGradeRange(schoolData.low_grade, schoolData.high_grade)}</p>
            </div>
            <div class="p-3 bg-lt-blue rounded">
              <p class="fs-12 text-gray-500 mb-1">Student-Teacher Ratio</p>
              <p class="text-lg font-bold text-brand-green-text mb-0">
                {schoolData.pupil_teacher_ratio ? `${schoolData.pupil_teacher_ratio.toFixed(1)}:1` : 'N/A'}
              </p>
            </div>
            <div class="p-3 bg-lt-blue rounded">
              <p class="fs-12 text-gray-500 mb-1">Teachers (FTE)</p>
              <p class="text-lg font-bold text-brand-green-text mb-0">{schoolData.fte_teachers ? Math.round(schoolData.fte_teachers) : 'N/A'}</p>
            </div>
            <div class="p-3 bg-lt-blue rounded">
              <p class="fs-12 text-gray-500 mb-1">School Type</p>
              <p class="text-lg font-bold text-brand-green-text mb-0">Private</p>
            </div>
            <div class="p-3 bg-lt-blue rounded">
              <p class="fs-12 text-gray-500 mb-1">Locale</p>
              <p class="text-lg font-bold text-brand-green-text mb-0">{getLocaleDescription(schoolData.locale)}</p>
            </div>
            {schoolData.county && (
              <div class="p-3 bg-lt-blue rounded">
                <p class="fs-12 text-gray-500 mb-1">County</p>
                <p class="text-lg font-bold text-brand-green-text mb-0">{schoolData.county}</p>
              </div>
            )}
            {schoolData.religious_affiliation && (
              <div class="p-3 bg-lt-blue rounded">
                <p class="fs-12 text-gray-500 mb-1">Religious Affiliation</p>
                <p class="text-lg font-bold text-brand-green-text mb-0">{schoolData.religious_affiliation}</p>
              </div>
            )}
            {schoolData.school_orientation && (
              <div class="p-3 bg-lt-blue rounded">
                <p class="fs-12 text-gray-500 mb-1">School Orientation</p>
                <p class="text-lg font-bold text-brand-green-text mb-0">{schoolData.school_orientation}</p>
              </div>
            )}
          </div>
        </div>

        <!-- Enrollment by Grade (if available) -->
        {(schoolData.pk_students || schoolData.k_students || schoolData.g1_students ||
          schoolData.g2_students || schoolData.g3_students || schoolData.g4_students ||
          schoolData.g5_students || schoolData.g6_students || schoolData.g7_students ||
          schoolData.g8_students || schoolData.g9_students || schoolData.g10_students ||
          schoolData.g11_students || schoolData.g12_students) && (
          <div class="box-rounded mb-5">
            <h2 class="text-brand-blue mb-4">Enrollment by Grade</h2>
            <div class="grid grid-cols-4 md:grid-cols-7 gap-2 text-center">
              {schoolData.pk_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">PK</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.pk_students}</p>
                </div>
              )}
              {schoolData.k_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">K</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.k_students}</p>
                </div>
              )}
              {schoolData.g1_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">1st</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g1_students}</p>
                </div>
              )}
              {schoolData.g2_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">2nd</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g2_students}</p>
                </div>
              )}
              {schoolData.g3_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">3rd</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g3_students}</p>
                </div>
              )}
              {schoolData.g4_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">4th</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g4_students}</p>
                </div>
              )}
              {schoolData.g5_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">5th</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g5_students}</p>
                </div>
              )}
              {schoolData.g6_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">6th</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g6_students}</p>
                </div>
              )}
              {schoolData.g7_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">7th</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g7_students}</p>
                </div>
              )}
              {schoolData.g8_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">8th</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g8_students}</p>
                </div>
              )}
              {schoolData.g9_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">9th</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g9_students}</p>
                </div>
              )}
              {schoolData.g10_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">10th</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g10_students}</p>
                </div>
              )}
              {schoolData.g11_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">11th</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g11_students}</p>
                </div>
              )}
              {schoolData.g12_students && (
                <div class="p-2 bg-gray-50 rounded">
                  <p class="fs-11 text-gray-500 mb-0">12th</p>
                  <p class="font-bold text-brand-green-text mb-0">{schoolData.g12_students}</p>
                </div>
              )}
            </div>
          </div>
        )}

        <!-- School IDs -->
        <div class="box-rounded mb-5">
          <h2 class="text-brand-blue mb-4">School Identifiers</h2>
          <div class="grid grid-cols-2 gap-4 fs-13">
            <div>
              <p class="text-gray-500 mb-1">NCES School ID</p>
              <p class="font-mono">{schoolData.nces_id || 'N/A'}</p>
            </div>
            <div>
              <p class="text-gray-500 mb-1">District/Association NCES ID</p>
              <p class="font-mono">{schoolData.district_nces_id || 'N/A'}</p>
            </div>
          </div>
        </div>

        <!-- Community Data -->
        {(censusEconomic || censusPopulation || censusSocial || censusHousing) && (
          <div id="community">
            <div class="box-rounded mb-5">
              <h2 class="text-brand-blue mb-2">Community Profile ({zipCode})</h2>
              <p class="text-gray-600 fs-13 mb-4">Demographic and economic data for the {zipCode} ZIP code area where {schoolData.school_name} is located.</p>

              <!-- Population Overview -->
              {censusPopulation && (
                <div class="mb-5">
                  <h3 class="text-brand-green-text fs-16 font-bold mb-3">Population Overview</h3>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    {censusPopulation.pop_total && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Total Population</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatNumber(censusPopulation.pop_total)}</p>
                      </div>
                    )}
                    {censusPopulation.pop_median_age && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Median Age</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{censusPopulation.pop_median_age}</p>
                      </div>
                    )}
                    {censusPopulation.pop_under_18 && censusPopulation.pop_total && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Under 18</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatPercent((censusPopulation.pop_under_18 / censusPopulation.pop_total) * 100)}</p>
                      </div>
                    )}
                    {censusPopulation.pop_65_plus && censusPopulation.pop_total && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">65+</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatPercent((censusPopulation.pop_65_plus / censusPopulation.pop_total) * 100)}</p>
                      </div>
                    )}
                  </div>
                </div>
              )}

              <!-- Income & Economy -->
              {censusEconomic && (
                <div class="mb-5">
                  <h3 class="text-brand-green-text fs-16 font-bold mb-3">Income & Economy</h3>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    {censusEconomic.income_median_household && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Median Household Income</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatCurrency(censusEconomic.income_median_household)}</p>
                      </div>
                    )}
                    {censusEconomic.income_per_capita && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Per Capita Income</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatCurrency(censusEconomic.income_per_capita)}</p>
                      </div>
                    )}
                    {censusEconomic.poverty_rate && censusEconomic.poverty_rate > 0 && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Poverty Rate</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatPercent(censusEconomic.poverty_rate)}</p>
                      </div>
                    )}
                    {censusEconomic.unemployment_rate && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Unemployment Rate</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatPercent(censusEconomic.unemployment_rate)}</p>
                      </div>
                    )}
                  </div>
                </div>
              )}

              <!-- Housing -->
              {censusHousing && (
                <div class="mb-5">
                  <h3 class="text-brand-green-text fs-16 font-bold mb-3">Housing</h3>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    {censusHousing.housing_median_value && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Median Home Value</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatCurrency(censusHousing.housing_median_value)}</p>
                      </div>
                    )}
                    {censusHousing.housing_median_rent && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Median Rent</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatCurrency(censusHousing.housing_median_rent)}</p>
                      </div>
                    )}
                    {censusHousing.housing_owner_occupied && censusHousing.housing_occupied && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Owner Occupied</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatPercent((censusHousing.housing_owner_occupied / censusHousing.housing_occupied) * 100)}</p>
                      </div>
                    )}
                    {censusHousing.housing_renter_occupied && censusHousing.housing_occupied && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Renter Occupied</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatPercent((censusHousing.housing_renter_occupied / censusHousing.housing_occupied) * 100)}</p>
                      </div>
                    )}
                  </div>
                </div>
              )}

              <!-- Education -->
              {censusSocial && (
                <div>
                  <h3 class="text-brand-green-text fs-16 font-bold mb-3">Education</h3>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    {censusSocial.edu_hs_or_higher_pct && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">High School or Higher</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatPercent(censusSocial.edu_hs_or_higher_pct)}</p>
                      </div>
                    )}
                    {censusSocial.edu_bachelors_or_higher_pct && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Bachelor's or Higher</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatPercent(censusSocial.edu_bachelors_or_higher_pct)}</p>
                      </div>
                    )}
                    {censusSocial.school_enrolled && (
                      <div class="p-3 bg-lt-blue rounded">
                        <p class="fs-11 text-gray-500 mb-1">Enrolled in School</p>
                        <p class="text-lg font-bold text-brand-green-text mb-0">{formatNumber(censusSocial.school_enrolled)}</p>
                      </div>
                    )}
                  </div>
                </div>
              )}

              <p class="text-gray-400 fs-11 mt-4 mb-0">Source: U.S. Census Bureau American Community Survey</p>
            </div>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <div class="lg:flex-shrink-0 lg:w-[336px]">
        <!-- Map -->
        <div class="box-rounded mb-4" id="map">
          <h3 class="text-brand-blue mb-3">Location</h3>
          {schoolData.lat && schoolData.lng ? (
            <>
              <div id="school-map" class="h-[250px] rounded mb-2"></div>
              <p class="text-center text-gray-600 fs-13 mb-3">{cityName}, {schoolData.state} {schoolData.zip}</p>
              <div class="flex justify-center gap-4 fs-13">
                <a href={`https://www.google.com/maps/search/?api=1&query=${schoolData.lat},${schoolData.lng}`} target="_blank" rel="noopener noreferrer">
                  Open in Google Maps
                </a>
                <span class="text-gray-400">|</span>
                <a href={`https://maps.apple.com/?ll=${schoolData.lat},${schoolData.lng}&q=${encodeURIComponent(schoolData.school_name)}`} target="_blank" rel="noopener noreferrer">
                  Open in Apple Maps
                </a>
              </div>
              <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
              <script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
              <script is:inline define:vars={{ lat: schoolData.lat, lng: schoolData.lng, schoolName: schoolData.school_name }}>
                document.addEventListener('DOMContentLoaded', function() {
                  const map = L.map('school-map').setView([lat, lng], 14);
                  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                  }).addTo(map);
                  L.marker([lat, lng]).addTo(map).bindPopup(schoolName);
                });
              </script>
            </>
          ) : (
            <p class="text-gray-500 fs-13">Location data not available</p>
          )}
        </div>

        <!-- Nearby Private Schools -->
        {nearbySchools.results && nearbySchools.results.length > 0 && (
          <div class="box-rounded mb-4">
            <h3 class="text-brand-blue mb-3">Other Private Schools in {cityName}</h3>
            <ul class="list-none m-0 p-0 fs-13">
              {nearbySchools.results.map((nearby: any, index: number) => {
                const citySlug = slugify(nearby.city);

                return (
                  <li class={`py-2 ${index < nearbySchools.results.length - 1 ? 'border-b border-dotted border-[#c1c1c1]' : ''}`}>
                    <a href={`/private-schools/${state}/${citySlug}/${nearby.page_name}`}>
                      {nearby.school_name}
                    </a>
                    {nearby.religious_affiliation && (
                      <span class="text-gray-500 fs-11 ml-1">({nearby.religious_affiliation})</span>
                    )}
                  </li>
                );
              })}
            </ul>
          </div>
        )}

        <!-- Sidebar Ad -->
        <div class="mb-4 flex justify-center">
          <div class="bg-gray-200 border-2 border-dashed border-gray-400 flex items-center justify-center text-gray-500 text-sm font-medium w-[336px] h-[280px]">
            Sidebar Ad (336x280)
          </div>
        </div>

        <!-- Quick Links -->
        <div class="box-rounded">
          <h3 class="text-brand-blue mb-3">Browse More Schools</h3>
          <ul class="list-none m-0 p-0 fs-13">
            <li class="py-2 border-b border-dotted border-[#c1c1c1]">
              <a href={`/private-schools/${state}`}>Private Schools in {schoolData.state_name}</a>
            </li>
            <li class="py-2 border-b border-dotted border-[#c1c1c1]">
              <a href={`/charter-schools/${state}`}>Charter Schools in {schoolData.state_name}</a>
            </li>
            <li class="py-2 border-b border-dotted border-[#c1c1c1]">
              <a href={`/magnet-schools/${state}`}>Magnet Schools in {schoolData.state_name}</a>
            </li>
            <li class="py-2 border-b border-dotted border-[#c1c1c1]">
              <a href={`/elementary-schools/${state}`}>Elementary Schools in {schoolData.state_name}</a>
            </li>
            <li class="py-2 border-b border-dotted border-[#c1c1c1]">
              <a href={`/high-schools/${state}`}>High Schools in {schoolData.state_name}</a>
            </li>
            <li class="py-2">
              <a href={`/colleges-universities/${state}`}>Colleges in {schoolData.state_name}</a>
            </li>
          </ul>
        </div>

        <!-- Newsletter Signup -->
        <NewsletterSignup />
      </div>
    </div>
  </div>
</Layout>
