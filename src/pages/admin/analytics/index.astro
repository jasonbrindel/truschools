---
import AdminNav from '@/components/AdminNav.astro';

const title = "Site Analytics - TruSchools";

// Get database connection
const db = (Astro.locals as any).runtime?.env?.DB;

// Check authentication
const cookies = Astro.request.headers.get('cookie') || '';
const sessionMatch = cookies.match(/session=([^;]+)/);
const sessionToken = sessionMatch ? sessionMatch[1] : null;

let isAuthenticated = false;
if (sessionToken && db) {
  const session = await db.prepare(`
    SELECT s.*, u.id as user_id
    FROM sessions s
    JOIN users u ON s.user_id = u.id
    WHERE s.token = ? AND s.expires_at > datetime('now')
  `).bind(sessionToken).first();
  isAuthenticated = !!session;
}

// Redirect if not authenticated
if (!isAuthenticated) {
  return Astro.redirect('/login?redirect=/admin/analytics');
}

// Set no-cache headers for admin page
Astro.response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');
Astro.response.headers.set('CDN-Cache-Control', 'no-store');
Astro.response.headers.set('Cloudflare-CDN-Cache-Control', 'no-store');
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>{title}</title>
  <style is:global>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #333;
      line-height: 1.5;
    }

    .analytics-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .analytics-header {
      margin-bottom: 32px;
    }

    .analytics-header h1 {
      font-size: 1.75rem;
      font-weight: 600;
      color: #111;
      margin-bottom: 4px;
    }

    .analytics-header p {
      color: #6b7280;
      font-size: 0.95rem;
    }

    .analytics-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 28px;
      flex-wrap: wrap;
      align-items: center;
    }

    .analytics-controls select,
    .analytics-controls input[type="date"] {
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.9rem;
      background: #fff;
      cursor: pointer;
      min-width: 140px;
      height: 42px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M3 5l3 3 3-3'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }

    .analytics-controls input[type="date"] {
      background-image: none;
      padding-right: 14px;
      min-width: 130px;
    }

    .analytics-controls select:focus,
    .analytics-controls input[type="date"]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .date-range-wrapper {
      display: none;
      align-items: center;
      gap: 8px;
    }

    .date-range-wrapper.visible {
      display: flex;
    }

    .date-range-wrapper span {
      color: #6b7280;
      font-size: 0.85rem;
    }

    .analytics-controls button {
      padding: 10px 20px;
      background: #1f2937;
      height: 42px;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    .analytics-controls button:hover {
      background: #374151;
    }

    .analytics-notrack-btn {
      background: #dc2626 !important;
    }

    .analytics-notrack-btn:hover {
      background: #b91c1c !important;
    }

    .analytics-notrack-btn.tracking {
      background: #16a34a !important;
    }

    .analytics-notrack-btn.tracking:hover {
      background: #15803d !important;
    }

    .analytics-stats {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-bottom: 28px;
    }

    @media (max-width: 1100px) {
      .analytics-stats { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 700px) {
      .analytics-stats { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 450px) {
      .analytics-stats { grid-template-columns: 1fr; }
    }

    .analytics-stat {
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      transition: box-shadow 0.15s;
    }

    .analytics-stat:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .analytics-stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #111;
      line-height: 1.2;
    }

    .analytics-stat-label {
      color: #6b7280;
      font-size: 0.85rem;
      margin-top: 4px;
      font-weight: 500;
    }

    .analytics-chart {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 24px;
      margin-bottom: 28px;
    }

    .analytics-chart h3 {
      font-weight: 600;
      font-size: 1rem;
      color: #111;
      margin-bottom: 20px;
    }

    .analytics-chart-bars {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      height: 140px;
      padding-bottom: 28px;
    }

    .analytics-bar {
      flex: 1;
      background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      position: relative;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .analytics-bar:hover {
      opacity: 0.85;
    }

    .analytics-bar::after {
      content: attr(data-label);
      position: absolute;
      bottom: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #9ca3af;
      white-space: nowrap;
    }

    .analytics-tables {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .analytics-tables-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    @media (max-width: 800px) {
      .analytics-tables-row { grid-template-columns: 1fr; }
    }

    .analytics-table-card.full-width {
      width: 100%;
    }

    .analytics-table-card.full-width td:first-child {
      max-width: none;
    }

    .analytics-table-card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .analytics-table-card h3 {
      padding: 16px 20px;
      border-bottom: 1px solid #f3f4f6;
      font-weight: 600;
      font-size: 0.95rem;
      color: #111;
      background: #fafafa;
    }

    .analytics-table-card table {
      width: 100%;
      border-collapse: collapse;
    }

    .analytics-table-card td {
      padding: 12px 20px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.875rem;
    }

    .analytics-table-card tr:last-child td {
      border-bottom: none;
    }

    .analytics-table-card tr:hover {
      background: #fafafa;
    }

    .analytics-table-card td:first-child {
      color: #374151;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .analytics-table-card td:not(:first-child) {
      text-align: right;
      color: #6b7280;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    .analytics-table-card th {
      padding: 10px 20px;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid #e5e7eb;
    }

    .analytics-table-card th:not(:first-child) {
      text-align: right;
    }

    .analytics-table-card thead tr:hover {
      background: transparent;
    }

    .analytics-empty {
      padding: 32px 20px;
      text-align: center;
      color: #9ca3af;
      font-size: 0.875rem;
    }

    .analytics-loading {
      padding: 64px 20px;
      text-align: center;
      color: #6b7280;
    }

    .analytics-loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .analytics-error {
      padding: 48px 20px;
      text-align: center;
      color: #ef4444;
      background: #fef2f2;
      border-radius: 12px;
      border: 1px solid #fecaca;
    }

    .analytics-pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      border-top: 1px solid #f3f4f6;
      background: #fafafa;
    }

    .analytics-pagination-info {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .analytics-pagination-btns {
      display: flex;
      gap: 8px;
    }

    .analytics-pagination-btns button {
      padding: 6px 12px;
      font-size: 0.8rem;
      background: #fff;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
      color: #374151;
      transition: all 0.15s;
    }

    .analytics-pagination-btns button:hover:not(:disabled) {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    .analytics-pagination-btns button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .analytics-pagination select {
      padding: 4px 8px;
      font-size: 0.8rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      color: #374151;
      cursor: pointer;
      margin-left: 12px;
    }
  </style>
</head>
<body>
  <AdminNav currentPage="analytics" />

  <div class="analytics-wrapper">
    <div class="analytics-header">
      <h1>Site Analytics</h1>
      <p>Track pageviews, visitors, and engagement across the site</p>
    </div>

    <div class="analytics-controls">
      <select id="days" name="days_x" autocomplete="off">
        <option value="1">Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="this_month">This Month</option>
        <option value="last_month">Last Month</option>
        <option value="custom">Custom Range</option>
      </select>
      <div id="date-range" class="date-range-wrapper">
        <input type="date" id="start-date" />
        <span>to</span>
        <input type="date" id="end-date" />
      </div>
      <button type="button" id="refresh-btn">Refresh</button>
      <button type="button" id="notrack-btn" class="analytics-notrack-btn"></button>
    </div>

    <div id="content">
      <div class="analytics-loading">
        <div class="analytics-loading-spinner"></div>
        Loading analytics...
      </div>
    </div>
  </div>

  <script is:inline>
    const dateRangeEl = document.getElementById('date-range');
    const startDateEl = document.getElementById('start-date');
    const endDateEl = document.getElementById('end-date');

    // Pagination state
    let currentPageData = null;
    let topPagesPage = 0;
    let topPagesPerPage = 20;

    // Set default date range values
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);
    startDateEl.value = weekAgo.toISOString().split('T')[0];
    endDateEl.value = today.toISOString().split('T')[0];
    startDateEl.max = today.toISOString().split('T')[0];
    endDateEl.max = today.toISOString().split('T')[0];

    async function loadAnalytics() {
      const daysValue = document.getElementById('days').value;
      const content = document.getElementById('content');

      content.innerHTML = '<div class="analytics-loading"><div class="analytics-loading-spinner"></div>Loading analytics...</div>';

      // Build request body based on selection
      let requestBody = { site: 'trueschools' };

      if (daysValue === 'yesterday') {
        requestBody.days = 'yesterday';
      } else if (daysValue === 'this_month' || daysValue === 'last_month') {
        requestBody.days = daysValue;
      } else if (daysValue === 'custom') {
        requestBody.startDate = startDateEl.value;
        requestBody.endDate = endDateEl.value;
      } else {
        requestBody.days = daysValue;
      }

      try {
        const res = await fetch('/api/analytics/stats?_=' + Date.now(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        const data = await res.json();

        if (data.error) {
          throw new Error(data.error);
        }

        currentPageData = data;
        topPagesPage = 0;
        renderAnalytics(data);
      } catch (err) {
        content.innerHTML = '<div class="analytics-error">Error loading analytics: ' + err.message + '</div>';
      }
    }

    function renderTopPagesTable() {
      if (!currentPageData || !currentPageData.topPages) return;

      const pages = currentPageData.topPages;
      const totalPages = Math.ceil(pages.length / topPagesPerPage);
      const start = topPagesPage * topPagesPerPage;
      const end = start + topPagesPerPage;
      const pageSlice = pages.slice(start, end);

      let html = '<table>';
      html += '<thead><tr><th>Page</th><th>Views</th><th>Avg Time</th></tr></thead>';
      html += '<tbody>';
      pageSlice.forEach(page => {
        const avgTime = page.avg_duration ? formatDuration(Math.round(page.avg_duration)) : '-';
        html += '<tr><td>' + page.path + '</td><td>' + page.views.toLocaleString() + '</td><td>' + avgTime + '</td></tr>';
      });
      html += '</tbody></table>';

      // Pagination controls
      if (pages.length > 10) {
        html += '<div class="analytics-pagination">';
        html += '<span class="analytics-pagination-info">Showing ' + (start + 1) + '-' + Math.min(end, pages.length) + ' of ' + pages.length;
        html += '<select id="pages-per-page">';
        [10, 20, 50, 100].forEach(n => {
          if (n <= pages.length || n === 10) {
            html += '<option value="' + n + '"' + (topPagesPerPage === n ? ' selected' : '') + '>' + n + ' per page</option>';
          }
        });
        html += '</select></span>';
        html += '<div class="analytics-pagination-btns">';
        html += '<button id="pages-prev"' + (topPagesPage === 0 ? ' disabled' : '') + '>Prev</button>';
        html += '<button id="pages-next"' + (topPagesPage >= totalPages - 1 ? ' disabled' : '') + '>Next</button>';
        html += '</div></div>';
      }

      document.getElementById('top-pages-content').innerHTML = html;

      // Attach pagination handlers
      const prevBtn = document.getElementById('pages-prev');
      const nextBtn = document.getElementById('pages-next');
      const perPageSelect = document.getElementById('pages-per-page');
      if (prevBtn) prevBtn.onclick = function() { topPagesPage--; renderTopPagesTable(); };
      if (nextBtn) nextBtn.onclick = function() { topPagesPage++; renderTopPagesTable(); };
      if (perPageSelect) perPageSelect.onchange = function() {
        topPagesPerPage = parseInt(this.value);
        topPagesPage = 0;
        renderTopPagesTable();
      };
    }

    function formatDuration(seconds) {
      if (!seconds || seconds === 0) return '0s';
      if (seconds < 60) return seconds + 's';
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return mins + 'm' + (secs ? ' ' + secs + 's' : '');
    }

    function getCategoryAggregates(topPages) {
      // Define categories with display names and minimum path depth for "detail" pages
      const categoryConfig = {
        'schools': { label: 'Public Schools', detailDepth: 4 },
        'private-schools': { label: 'Private Schools', detailDepth: 4 },
        'charter-schools': { label: 'Charter Schools', detailDepth: 4 },
        'magnet-schools': { label: 'Magnet Schools', detailDepth: 4 },
        'colleges-universities': { label: 'Colleges & Universities', detailDepth: 3 },
        'elementary-schools': { label: 'Elementary Schools', detailDepth: 2 },
        'middle-schools': { label: 'Middle Schools', detailDepth: 2 },
        'high-schools': { label: 'High Schools', detailDepth: 2 },
        'preschools': { label: 'Preschools', detailDepth: 2 },
        'beauty-schools': { label: 'Beauty Schools', detailDepth: 3 },
        'culinary-schools': { label: 'Culinary Schools', detailDepth: 3 },
        'healthcare-schools': { label: 'Healthcare Schools', detailDepth: 3 },
        'technology-schools': { label: 'Technology Schools', detailDepth: 3 },
        'trade-schools': { label: 'Trade Schools', detailDepth: 3 },
        'education-articles': { label: 'Articles', detailDepth: 2 },
        'sat-prep': { label: 'SAT Prep', detailDepth: 2 },
        'classes': { label: 'Classes', detailDepth: 4 },
        'admin': { label: 'Admin', detailDepth: 2 },
      };

      const categories = {};

      topPages.forEach(page => {
        // Extract category from path (e.g., /schools/... -> schools)
        const match = page.path.match(/^\/([^\/]+)/);
        const category = match ? match[1] : 'home';

        // Count path segments (e.g., /schools/ga/atlanta/school-name = 4)
        const pathSegments = page.path.split('/').filter(s => s.length > 0).length;
        const config = categoryConfig[category] || { label: null, detailDepth: 99 };
        const isDetailPage = pathSegments >= config.detailDepth;

        if (!categories[category]) {
          categories[category] = {
            views: 0, totalDuration: 0, durationCount: 0, pages: 0,
            detailTotalDuration: 0, detailDurationCount: 0
          };
        }
        categories[category].views += page.views;
        categories[category].pages += 1;
        if (page.avg_duration && page.avg_duration > 0) {
          categories[category].totalDuration += page.avg_duration * page.views;
          categories[category].durationCount += page.views;

          // Track detail pages separately
          if (isDetailPage) {
            categories[category].detailTotalDuration += page.avg_duration * page.views;
            categories[category].detailDurationCount += page.views;
          }
        }
      });

      // Convert to array and calculate avg duration
      return Object.entries(categories)
        .map(([key, data]) => ({
          category: key,
          label: (categoryConfig[key]?.label) || key.charAt(0).toUpperCase() + key.slice(1).replace(/-/g, ' '),
          views: data.views,
          pages: data.pages,
          avgDuration: data.durationCount > 0 ? Math.round(data.totalDuration / data.durationCount) : 0,
          detailAvgDuration: data.detailDurationCount > 0 ? Math.round(data.detailTotalDuration / data.detailDurationCount) : 0
        }))
        .sort((a, b) => b.views - a.views);
    }

    function getCountryFlag(code) {
      if (!code || code.length !== 2) return '';
      const codePoints = code.toUpperCase().split('').map(c => 127397 + c.charCodeAt(0));
      return String.fromCodePoint(...codePoints) + ' ';
    }

    function renderAnalytics(data) {
      let html = '';

      // Stats cards
      html += '<div class="analytics-stats">';
      html += '<div class="analytics-stat"><div class="analytics-stat-value">' + data.pageviews.toLocaleString() + '</div><div class="analytics-stat-label">Pageviews</div></div>';
      html += '<div class="analytics-stat"><div class="analytics-stat-value">' + data.sessions.toLocaleString() + '</div><div class="analytics-stat-label">Unique Visitors</div></div>';
      html += '<div class="analytics-stat"><div class="analytics-stat-value">' + formatDuration(data.avgDuration) + '</div><div class="analytics-stat-label">Avg. Time on Page</div></div>';
      html += '<div class="analytics-stat"><div class="analytics-stat-value">' + formatDuration(data.avgSessionDuration) + '</div><div class="analytics-stat-label">Avg. Session Duration</div></div>';
      html += '<div class="analytics-stat"><div class="analytics-stat-value">' + data.pagesPerSession + '</div><div class="analytics-stat-label">Pages per Visit</div></div>';
      html += '</div>';

      // Chart
      if (data.byDay && data.byDay.length > 0) {
        const maxViews = Math.max(...data.byDay.map(d => d.views));
        html += '<div class="analytics-chart">';
        html += '<h3>Pageviews Over Time</h3>';
        html += '<div class="analytics-chart-bars">';
        data.byDay.forEach(day => {
          const height = maxViews > 0 ? Math.max((day.views / maxViews * 100), 4) : 4;
          const label = day.date.slice(5); // MM-DD
          html += '<div class="analytics-bar" style="height: ' + height + '%" data-label="' + label + '" title="' + day.date + ': ' + day.views + ' views"></div>';
        });
        html += '</div>';
        html += '</div>';
      }

      // Tables
      html += '<div class="analytics-tables">';

      // Category Breakdown (full width)
      if (data.topPages && data.topPages.length > 0) {
        const categories = getCategoryAggregates(data.topPages);
        html += '<div class="analytics-table-card full-width"><h3>Traffic by Section</h3>';
        html += '<table>';
        html += '<thead><tr><th>Section</th><th>Pages</th><th>Views</th><th>Avg Time</th><th>Avg Time (Detail Pages)</th></tr></thead>';
        html += '<tbody>';
        categories.forEach(cat => {
          const avgTime = cat.avgDuration ? formatDuration(cat.avgDuration) : '-';
          const detailAvgTime = cat.detailAvgDuration ? formatDuration(cat.detailAvgDuration) : '-';
          html += '<tr><td>' + cat.label + '</td><td>' + cat.pages.toLocaleString() + '</td><td>' + cat.views.toLocaleString() + '</td><td>' + avgTime + '</td><td>' + detailAvgTime + '</td></tr>';
        });
        html += '</tbody></table></div>';
      }

      // Top Pages (full width) - content rendered separately for pagination
      html += '<div class="analytics-table-card full-width"><h3>Top Pages</h3>';
      html += '<div id="top-pages-content">';
      if (data.topPages && data.topPages.length > 0) {
        html += '<div class="analytics-loading" style="padding: 20px;">Loading...</div>';
      } else {
        html += '<div class="analytics-empty">No page data yet</div>';
      }
      html += '</div></div>';

      // Row with Referrers and Countries side by side
      html += '<div class="analytics-tables-row">';

      // Referrers
      html += '<div class="analytics-table-card"><h3>Top Referrers</h3>';
      if (data.topReferrers && data.topReferrers.length > 0) {
        html += '<table>';
        data.topReferrers.slice(0, 10).forEach(ref => {
          let display = ref.referrer || '(direct)';
          try {
            if (display.startsWith('http')) {
              display = new URL(display).hostname;
            }
          } catch (e) {}
          html += '<tr><td title="' + (ref.referrer || 'Direct traffic') + '">' + display + '</td><td>' + ref.count.toLocaleString() + '</td></tr>';
        });
        html += '</table>';
      } else {
        html += '<div class="analytics-empty">No referrer data yet</div>';
      }
      html += '</div>';

      // Countries
      html += '<div class="analytics-table-card"><h3>Top Countries</h3>';
      if (data.countries && data.countries.length > 0) {
        html += '<table>';
        data.countries.slice(0, 10).forEach(country => {
          const flag = getCountryFlag(country.country);
          const name = country.country || 'Unknown';
          html += '<tr><td>' + flag + name + '</td><td>' + country.count.toLocaleString() + '</td></tr>';
        });
        html += '</table>';
      } else {
        html += '<div class="analytics-empty">No country data yet</div>';
      }
      html += '</div>';

      html += '</div>'; // Close analytics-tables-row

      html += '</div>'; // Close analytics-tables

      document.getElementById('content').innerHTML = html;

      // Render paginated Top Pages table
      if (data.topPages && data.topPages.length > 0) {
        renderTopPagesTable();
      }
    }

    // Set default to Today
    // Using pageshow event to handle Safari's bfcache form restoration
    const daysSelect = document.getElementById('days');

    function initAnalytics() {
      daysSelect.value = '1';
      loadAnalytics();
    }

    // pageshow fires AFTER Safari restores form state from bfcache
    window.addEventListener('pageshow', function(event) {
      // event.persisted is true if page was restored from bfcache
      if (event.persisted) {
        initAnalytics();
      }
    });

    // Initial load
    initAnalytics();

    // Event listeners
    daysSelect.addEventListener('change', function() {
      // Show/hide date range inputs
      if (daysSelect.value === 'custom') {
        dateRangeEl.classList.add('visible');
      } else {
        dateRangeEl.classList.remove('visible');
      }
      loadAnalytics();
    });
    document.getElementById('refresh-btn').addEventListener('click', loadAnalytics);
    startDateEl.addEventListener('change', loadAnalytics);
    endDateEl.addEventListener('change', loadAnalytics);

    // No-track toggle
    const notrackBtn = document.getElementById('notrack-btn');
    function updateNotrackBtn() {
      const isTracking = !localStorage.getItem('_notrack');
      notrackBtn.textContent = isTracking ? 'Tracking: ON' : 'Tracking: OFF';
      notrackBtn.classList.toggle('tracking', isTracking);
    }
    updateNotrackBtn();
    notrackBtn.addEventListener('click', function() {
      if (localStorage.getItem('_notrack')) {
        localStorage.removeItem('_notrack');
      } else {
        localStorage.setItem('_notrack', '1');
      }
      updateNotrackBtn();
    });
  </script>
</body>
</html>
