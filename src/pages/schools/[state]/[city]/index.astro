---
import Layout from '@/layouts/Layout.astro';

const { state, city } = Astro.params;

// Get database connection
const db = Astro.locals.runtime.env.DB;

// Get state info
const stateResult = await db.prepare(
  'SELECT * FROM states WHERE slug = ?'
).bind(state).first();

if (!stateResult) {
  return Astro.redirect('/404');
}

const stateData = stateResult as any;

// Slugify function
function slugify(text: string): string {
  return text.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
}

// Get all schools in this state
const schoolsResult = await db.prepare(`
  SELECT s.*, st.name as state_name, st.slug as state_slug
  FROM schools s
  JOIN states st ON s.state = st.abbr
  WHERE st.slug = ?
  ORDER BY s.school_name
`).bind(state).all();

// Filter schools by city slug match
const allSchools = (schoolsResult.results || []) as any[];
const schools = allSchools.filter(s => slugify(s.city || '') === city);

if (schools.length === 0) {
  return Astro.redirect('/404');
}

// Get city name from first school (convert to title case)
function toTitleCase(str: string): string {
  return str.toLowerCase().replace(/\b\w/g, (char) => char.toUpperCase());
}
const cityName = toTitleCase(schools[0].city || '');

// Group schools by type
const preschools = schools.filter(s => s.is_preschool);
const kindergartens = schools.filter(s => s.is_kindergarten);
const elementary = schools.filter(s => s.is_elementary);
const middle = schools.filter(s => s.is_middle_school);
const high = schools.filter(s => s.is_high_school);

// Get census data for the city (use first school's zip)
const zipCode = schools[0].zip?.substring(0, 5);
let censusEconomic = null;
let censusPopulation = null;
let censusHousing = null;

if (zipCode) {
  const [economicResult, populationResult, housingResult] = await Promise.all([
    db.prepare('SELECT * FROM census_economic WHERE zcta = ?').bind(zipCode).first(),
    db.prepare('SELECT * FROM census_population WHERE zcta = ?').bind(zipCode).first(),
    db.prepare('SELECT * FROM census_housing WHERE zcta = ?').bind(zipCode).first()
  ]);
  censusEconomic = economicResult;
  censusPopulation = populationResult;
  censusHousing = housingResult;
}

// Format functions
function formatNumber(num: number | null): string {
  if (num === null || num === undefined) return 'N/A';
  return num.toLocaleString();
}

function formatCurrency(num: number | null): string {
  if (num === null || num === undefined) return 'N/A';
  return '$' + num.toLocaleString();
}

function formatPercent(num: number | null): string {
  if (num === null || num === undefined) return 'N/A';
  return num.toFixed(1) + '%';
}

// Get school type label
function getSchoolType(school: any): string {
  if (school.is_public) {
    return school.is_charter ? 'Charter' : 'Public';
  }
  return 'Private';
}

// Get school level label
function getSchoolLevel(school: any): string {
  const levels = [];
  if (school.is_preschool) levels.push('Preschool');
  if (school.is_kindergarten) levels.push('Kindergarten');
  if (school.is_elementary) levels.push('Elementary');
  if (school.is_middle_school) levels.push('Middle');
  if (school.is_high_school) levels.push('High');
  return levels.join(', ') || 'K-12';
}

// Get the appropriate link for a school based on its type
function getSchoolLink(school: any): string {
  if (school.is_high_school) return `/high-schools/${state}/${city}/${school.page_name}`;
  if (school.is_middle_school) return `/middle-schools/${state}/${city}/${school.page_name}`;
  if (school.is_elementary) return `/elementary-schools/${state}/${city}/${school.page_name}`;
  if (school.is_kindergarten) return `/kindergartens/${state}/${city}/${school.page_name}`;
  if (school.is_preschool) return `/preschools/${state}/${city}/${school.page_name}`;
  return `/high-schools/${state}/${city}/${school.page_name}`;
}

// Format grade range
function formatGradeRange(low: string | null, high: string | null): string {
  if (!low && !high) return 'N/A';

  const formatGrade = (g: string) => {
    if (g === 'PK') return 'PK';
    if (g === 'KG' || g === 'K') return 'K';
    const num = parseInt(g);
    if (!isNaN(num)) return num.toString();
    return g;
  };

  if (low === high) return `Grade ${formatGrade(low!)}`;
  return `Grades ${formatGrade(low!)} - ${formatGrade(high!)}`;
}

const pageTitle = `${cityName} Schools - Directory of Schools in ${cityName}, ${stateData.abbr}`;
const pageDescription = `Find and compare ${schools.length} schools in ${cityName}, ${stateData.name}. View preschools, elementary, middle, and high schools with contact information and community demographics.`;
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="container py-5">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-4">
      <ol class="flex flex-wrap items-center gap-2 text-gray-600">
        <li><a href="/" class="hover:text-brand-blue">Home</a></li>
        <li class="text-gray-400">/</li>
        <li><a href="/schools" class="hover:text-brand-blue">K-12 Schools</a></li>
        <li class="text-gray-400">/</li>
        <li><a href={`/schools/${state}`} class="hover:text-brand-blue">{stateData.name}</a></li>
        <li class="text-gray-400">/</li>
        <li class="text-gray-900 font-medium">{cityName}</li>
      </ol>
    </nav>

    <div class="flex flex-col lg:flex-row gap-6">
      <!-- Main Content -->
      <div class="flex-1">
        <div class="box-rounded mb-5">
          <h1 class="text-brand-blue text-2xl mb-2">{cityName} Schools</h1>
          <p class="text-gray-600 mb-4">Directory of Schools in {cityName}, {stateData.abbr}</p>
          <p class="text-brand-green-text font-bold">Total Schools Listed: {schools.length}</p>
        </div>

        <!-- Jump to Section Links -->
        {(preschools.length > 0 || kindergartens.length > 0 || elementary.length > 0 || middle.length > 0 || high.length > 0) && (
          <div class="box-rounded mb-5">
            <h3 class="text-brand-green-text font-bold mb-3">Jump to Section</h3>
            <div class="flex flex-wrap gap-2">
              {preschools.length > 0 && (
                <a href="#preschools" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:bg-brand-blue-dark">
                  Preschools ({preschools.length})
                </a>
              )}
              {kindergartens.length > 0 && (
                <a href="#kindergartens" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:bg-brand-blue-dark">
                  Kindergartens ({kindergartens.length})
                </a>
              )}
              {elementary.length > 0 && (
                <a href="#elementary" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:bg-brand-blue-dark">
                  Elementary ({elementary.length})
                </a>
              )}
              {middle.length > 0 && (
                <a href="#middle" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:bg-brand-blue-dark">
                  Middle ({middle.length})
                </a>
              )}
              {high.length > 0 && (
                <a href="#high" class="px-3 py-1 bg-brand-blue text-white rounded text-sm hover:bg-brand-blue-dark">
                  High Schools ({high.length})
                </a>
              )}
            </div>
          </div>
        )}

        <!-- Preschools Section -->
        {preschools.length > 0 && (
          <div id="preschools" class="mb-6 scroll-mt-4">
            <h2 class="text-brand-green-text text-xl font-bold mb-4 border-b pb-2">Preschools in {cityName}</h2>
            <div class="space-y-4">
              {preschools.map((school) => (
                <div class="box-rounded hover:shadow-md transition-shadow">
                  <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                    <div class="flex-1">
                      <h3 class="text-lg mb-1">
                        <a href={`/preschools/${state}/${city}/${school.page_name}`} class="text-brand-blue hover:underline font-semibold">
                          {school.school_name}
                        </a>
                      </h3>
                      <p class="text-gray-600 fs-13 mb-2">
                        <span class="inline-block px-2 py-0.5 bg-gray-100 rounded text-xs font-medium mr-2">{getSchoolType(school)}</span>
                        {school.grade_lo && school.grade_hi && (
                          <span class="text-gray-500">{formatGradeRange(school.grade_lo, school.grade_hi)}</span>
                        )}
                      </p>
                      <p class="text-gray-700 fs-13">
                        {school.street_address && <span>{school.street_address}, </span>}
                        {school.city}, {school.state} {school.zip?.substring(0, 5)}
                      </p>
                    </div>
                    <div class="flex-shrink-0">
                      <a href={`/preschools/${state}/${city}/${school.page_name}`} class="inline-block px-4 py-2 bg-brand-green text-white rounded hover:bg-brand-green-dark transition-colors fs-13">
                        View Details
                      </a>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Kindergartens Section -->
        {kindergartens.length > 0 && (
          <div id="kindergartens" class="mb-6 scroll-mt-4">
            <h2 class="text-brand-green-text text-xl font-bold mb-4 border-b pb-2">Kindergartens in {cityName}</h2>
            <div class="space-y-4">
              {kindergartens.map((school) => (
                <div class="box-rounded hover:shadow-md transition-shadow">
                  <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                    <div class="flex-1">
                      <h3 class="text-lg mb-1">
                        <a href={`/kindergartens/${state}/${city}/${school.page_name}`} class="text-brand-blue hover:underline font-semibold">
                          {school.school_name}
                        </a>
                      </h3>
                      <p class="text-gray-600 fs-13 mb-2">
                        <span class="inline-block px-2 py-0.5 bg-gray-100 rounded text-xs font-medium mr-2">{getSchoolType(school)}</span>
                        {school.grade_lo && school.grade_hi && (
                          <span class="text-gray-500">{formatGradeRange(school.grade_lo, school.grade_hi)}</span>
                        )}
                      </p>
                      <p class="text-gray-700 fs-13">
                        {school.street_address && <span>{school.street_address}, </span>}
                        {school.city}, {school.state} {school.zip?.substring(0, 5)}
                      </p>
                    </div>
                    <div class="flex-shrink-0">
                      <a href={`/kindergartens/${state}/${city}/${school.page_name}`} class="inline-block px-4 py-2 bg-brand-green text-white rounded hover:bg-brand-green-dark transition-colors fs-13">
                        View Details
                      </a>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Elementary Schools Section -->
        {elementary.length > 0 && (
          <div id="elementary" class="mb-6 scroll-mt-4">
            <h2 class="text-brand-green-text text-xl font-bold mb-4 border-b pb-2">Elementary Schools in {cityName}</h2>
            <div class="space-y-4">
              {elementary.map((school) => (
                <div class="box-rounded hover:shadow-md transition-shadow">
                  <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                    <div class="flex-1">
                      <h3 class="text-lg mb-1">
                        <a href={`/elementary-schools/${state}/${city}/${school.page_name}`} class="text-brand-blue hover:underline font-semibold">
                          {school.school_name}
                        </a>
                      </h3>
                      <p class="text-gray-600 fs-13 mb-2">
                        <span class="inline-block px-2 py-0.5 bg-gray-100 rounded text-xs font-medium mr-2">{getSchoolType(school)}</span>
                        {school.grade_lo && school.grade_hi && (
                          <span class="text-gray-500">{formatGradeRange(school.grade_lo, school.grade_hi)}</span>
                        )}
                      </p>
                      <p class="text-gray-700 fs-13">
                        {school.street_address && <span>{school.street_address}, </span>}
                        {school.city}, {school.state} {school.zip?.substring(0, 5)}
                      </p>
                    </div>
                    <div class="flex-shrink-0">
                      <a href={`/elementary-schools/${state}/${city}/${school.page_name}`} class="inline-block px-4 py-2 bg-brand-green text-white rounded hover:bg-brand-green-dark transition-colors fs-13">
                        View Details
                      </a>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Middle Schools Section -->
        {middle.length > 0 && (
          <div id="middle" class="mb-6 scroll-mt-4">
            <h2 class="text-brand-green-text text-xl font-bold mb-4 border-b pb-2">Middle Schools in {cityName}</h2>
            <div class="space-y-4">
              {middle.map((school) => (
                <div class="box-rounded hover:shadow-md transition-shadow">
                  <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                    <div class="flex-1">
                      <h3 class="text-lg mb-1">
                        <a href={`/middle-schools/${state}/${city}/${school.page_name}`} class="text-brand-blue hover:underline font-semibold">
                          {school.school_name}
                        </a>
                      </h3>
                      <p class="text-gray-600 fs-13 mb-2">
                        <span class="inline-block px-2 py-0.5 bg-gray-100 rounded text-xs font-medium mr-2">{getSchoolType(school)}</span>
                        {school.grade_lo && school.grade_hi && (
                          <span class="text-gray-500">{formatGradeRange(school.grade_lo, school.grade_hi)}</span>
                        )}
                      </p>
                      <p class="text-gray-700 fs-13">
                        {school.street_address && <span>{school.street_address}, </span>}
                        {school.city}, {school.state} {school.zip?.substring(0, 5)}
                      </p>
                    </div>
                    <div class="flex-shrink-0">
                      <a href={`/middle-schools/${state}/${city}/${school.page_name}`} class="inline-block px-4 py-2 bg-brand-green text-white rounded hover:bg-brand-green-dark transition-colors fs-13">
                        View Details
                      </a>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- High Schools Section -->
        {high.length > 0 && (
          <div id="high" class="mb-6 scroll-mt-4">
            <h2 class="text-brand-green-text text-xl font-bold mb-4 border-b pb-2">High Schools in {cityName}</h2>
            <div class="space-y-4">
              {high.map((school) => (
                <div class="box-rounded hover:shadow-md transition-shadow">
                  <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                    <div class="flex-1">
                      <h3 class="text-lg mb-1">
                        <a href={`/high-schools/${state}/${city}/${school.page_name}`} class="text-brand-blue hover:underline font-semibold">
                          {school.school_name}
                        </a>
                      </h3>
                      <p class="text-gray-600 fs-13 mb-2">
                        <span class="inline-block px-2 py-0.5 bg-gray-100 rounded text-xs font-medium mr-2">{getSchoolType(school)}</span>
                        {school.grade_lo && school.grade_hi && (
                          <span class="text-gray-500">{formatGradeRange(school.grade_lo, school.grade_hi)}</span>
                        )}
                      </p>
                      <p class="text-gray-700 fs-13">
                        {school.street_address && <span>{school.street_address}, </span>}
                        {school.city}, {school.state} {school.zip?.substring(0, 5)}
                      </p>
                    </div>
                    <div class="flex-shrink-0">
                      <a href={`/high-schools/${state}/${city}/${school.page_name}`} class="inline-block px-4 py-2 bg-brand-green text-white rounded hover:bg-brand-green-dark transition-colors fs-13">
                        View Details
                      </a>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <div class="lg:flex-shrink-0 lg:w-[336px]">
        <!-- Community Stats -->
        {(censusEconomic || censusPopulation || censusHousing) && (
          <div class="box-rounded mb-4">
            <h3 class="text-brand-green-text font-bold mb-3">{cityName} Demographics</h3>
            <div class="space-y-3 fs-13">
              {censusPopulation?.pop_total && (
                <div class="flex justify-between">
                  <span class="text-gray-600">Population</span>
                  <span class="font-medium">{formatNumber(censusPopulation.pop_total)}</span>
                </div>
              )}
              {censusPopulation?.pop_median_age && (
                <div class="flex justify-between">
                  <span class="text-gray-600">Median Age</span>
                  <span class="font-medium">{censusPopulation.pop_median_age}</span>
                </div>
              )}
              {censusEconomic?.income_median_household && (
                <div class="flex justify-between">
                  <span class="text-gray-600">Median Household Income</span>
                  <span class="font-medium">{formatCurrency(censusEconomic.income_median_household)}</span>
                </div>
              )}
              {censusHousing?.housing_median_value && (
                <div class="flex justify-between">
                  <span class="text-gray-600">Median Home Value</span>
                  <span class="font-medium">{formatCurrency(censusHousing.housing_median_value)}</span>
                </div>
              )}
              {censusHousing?.housing_median_rent && (
                <div class="flex justify-between">
                  <span class="text-gray-600">Median Rent</span>
                  <span class="font-medium">{formatCurrency(censusHousing.housing_median_rent)}</span>
                </div>
              )}
              {censusEconomic?.poverty_rate && censusEconomic.poverty_rate > 0 && (
                <div class="flex justify-between">
                  <span class="text-gray-600">Poverty Rate</span>
                  <span class="font-medium">{formatPercent(censusEconomic.poverty_rate)}</span>
                </div>
              )}
              {censusEconomic?.unemployment_rate && (
                <div class="flex justify-between">
                  <span class="text-gray-600">Unemployment Rate</span>
                  <span class="font-medium">{formatPercent(censusEconomic.unemployment_rate)}</span>
                </div>
              )}
            </div>
            <p class="text-gray-400 fs-11 mt-3">Source: U.S. Census Bureau ACS</p>
          </div>
        )}

        <!-- School Type Counts -->
        <div class="box-rounded mb-4">
          <h3 class="text-brand-green-text font-bold mb-3">Schools by Type</h3>
          <ul class="space-y-2 fs-13">
            {preschools.length > 0 && (
              <li class="flex justify-between">
                <a href={`/preschools/${state}/${city}`} class="text-brand-blue hover:underline">Preschools</a>
                <span class="text-gray-600">{preschools.length}</span>
              </li>
            )}
            {kindergartens.length > 0 && (
              <li class="flex justify-between">
                <a href={`/kindergartens/${state}/${city}`} class="text-brand-blue hover:underline">Kindergartens</a>
                <span class="text-gray-600">{kindergartens.length}</span>
              </li>
            )}
            {elementary.length > 0 && (
              <li class="flex justify-between">
                <a href={`/elementary-schools/${state}/${city}`} class="text-brand-blue hover:underline">Elementary</a>
                <span class="text-gray-600">{elementary.length}</span>
              </li>
            )}
            {middle.length > 0 && (
              <li class="flex justify-between">
                <a href={`/middle-schools/${state}/${city}`} class="text-brand-blue hover:underline">Middle Schools</a>
                <span class="text-gray-600">{middle.length}</span>
              </li>
            )}
            {high.length > 0 && (
              <li class="flex justify-between">
                <a href={`/high-schools/${state}/${city}`} class="text-brand-blue hover:underline">High Schools</a>
                <span class="text-gray-600">{high.length}</span>
              </li>
            )}
          </ul>
        </div>

        <!-- Ad Placeholder -->
        <div class="box-rounded mb-4">
          <div class="bg-gray-100 h-[280px] flex items-center justify-center text-gray-400 fs-13">
            Advertisement
          </div>
        </div>

        <!-- Browse -->
        <div class="box-rounded">
          <h3 class="text-brand-green-text font-bold mb-3">Browse Schools</h3>
          <ul class="space-y-2 fs-13">
            <li>
              <a href={`/schools/${state}`} class="text-brand-blue hover:underline">
                All Schools in {stateData.name}
              </a>
            </li>
            <li>
              <a href="/schools" class="text-brand-blue hover:underline">
                Schools by State
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</Layout>
